<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Aurora Scheduler</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link href="/assets/css/main.css" rel="stylesheet">
	<!-- Analytics -->
	<script type="text/javascript">
		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-45879646-1']);
		  _gaq.push(['_setDomainName', 'apache.org']);
		  _gaq.push(['_trackPageview']);

		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
	</script>
  </head>
  <body>
    <div class="container-fluid section-header">
  <div class="container">
    <div class="nav nav-bar">
    <a href="/"><img src="/assets/img/aurora_logo_dkbkg.svg" width="300" alt="Transparent Aurora Scheduler logo with dark background"/></a>
    <ul class="nav navbar-nav navbar-right">
      <li><a href="/documentation/latest/">Documentation</a></li>
      <li><a href="/community/">Community</a></li>
      <li><a href="/downloads/">Downloads</a></li>
      <li><a href="/blog/">Blog</a></li>
    </ul>
    </div>
  </div>
</div>
	
    <div class="container-fluid">
      <div class="container content">
        <h1 id="command-hooks-for-the-aurora-client">Command Hooks for the Aurora Client</h1>

<h2 id="introduction-motivation">Introduction/Motivation</h2>

<p>We&rsquo;ve got hooks in the client that surround API calls. These are
pretty awkward, because they don&rsquo;t correlate with user actions. For
example, suppose we wanted a policy that said users weren&rsquo;t allowed to
kill all instances of a production job at once.</p>

<p>Right now, all that we could hook would be the &ldquo;killJob&rdquo; api call. But
kill (at least in newer versions of the client) normally runs in
batches. If a user called killall, what we would see on the API level
is a series of &ldquo;killJob&rdquo; calls, each of which specified a batch of
instances. We woudn&rsquo;t be able to distinguish between really killing
all instances of a job (which is forbidden under this policy), and
carefully killing in batches (which is permitted.) In each case, the
hook would just see a series of API calls, and couldn&rsquo;t find out what
the actual command being executed was!</p>

<p>For most policy enforcement, what we really want to be able to do is
look at and vet the commands that a user is performing, not the API
calls that the client uses to implement those commands.</p>

<p>So I propose that we add a new kind of hooks, which surround noun/verb
commands. A hook will register itself to handle a collection of (noun,
verb) pairs. Whenever any of those noun/verb commands are invoked, the
hooks methods will be called around the execution of the verb. A
pre-hook will have the ability to reject a command, preventing the
verb from being executed.</p>

<h2 id="registering-hooks">Registering Hooks</h2>

<p>These hooks will be registered via configuration plugins. A configuration plugin
can register hooks using an API. Hooks registered this way are, effectively,
hardwired into the client executable.</p>

<p>The order of execution of hooks is unspecified: they may be called in
any order. There is no way to guarantee that one hook will execute
before some other hook.</p>

<h3 id="global-hooks">Global Hooks</h3>

<p>Commands registered by the python call are called <em>global</em> hooks,
because they will run for all configurations, whether or not they
specify any hooks in the configuration file.</p>

<p>In the implementation, hooks are registered in the module
<code>apache.aurora.client.cli.command_hooks</code>, using the class
<code>GlobalCommandHookRegistry</code>. A global hook can be registered by calling
<code>GlobalCommandHookRegistry.register_command_hook</code> in a configuration plugin.</p>

<h3 id="the-api">The API</h3>
<pre class="highlight objective_c"><code><span class="n">class</span> <span class="n">CommandHook</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
  <span class="k">@property</span>
  <span class="n">def</span> <span class="n">name</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
    <span class="s">"""Returns a name for the hook."</span>

  <span class="n">def</span> <span class="n">get_nouns</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
    <span class="s">"""Return the nouns that have verbs that should invoke this hook."""</span>

  <span class="n">def</span> <span class="n">get_verbs</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">noun</span><span class="p">)</span><span class="o">:</span>
    <span class="s">"""Return the verbs for a particular noun that should invoke his hook."""</span>

  <span class="err">@abstractmethod</span>
  <span class="n">def</span> <span class="n">pre_command</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">noun</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">commandline</span><span class="p">)</span><span class="o">:</span>
    <span class="s">"""Execute a hook before invoking a verb.</span><span class="err">
</span><span class="s">    * noun: the noun being invoked.</span><span class="err">
</span><span class="s">    * verb: the verb being invoked.</span><span class="err">
</span><span class="s">    * context: the context object that will be used to invoke the verb.</span><span class="err">
</span><span class="s">      The options object will be initialized before calling the hook</span><span class="err">
</span><span class="s">    * commandline: the original argv collection used to invoke the client.</span><span class="err">
</span><span class="s">    Returns: True if the command should be allowed to proceed; False if the command</span><span class="err">
</span><span class="s">    should be rejected.</span><span class="err">
</span><span class="s">    """</span>

  <span class="n">def</span> <span class="n">post_command</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">noun</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">commandline</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span><span class="o">:</span>
    <span class="s">"""Execute a hook after invoking a verb.</span><span class="err">
</span><span class="s">    * noun: the noun being invoked.</span><span class="err">
</span><span class="s">    * verb: the verb being invoked.</span><span class="err">
</span><span class="s">    * context: the context object that will be used to invoke the verb.</span><span class="err">
</span><span class="s">      The options object will be initialized before calling the hook</span><span class="err">
</span><span class="s">    * commandline: the original argv collection used to invoke the client.</span><span class="err">
</span><span class="s">    * result: the result code returned by the verb.</span><span class="err">
</span><span class="s">    Returns: nothing</span><span class="err">
</span><span class="s">    """</span>

<span class="n">class</span> <span class="n">GlobalCommandHookRegistry</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="o">:</span>
  <span class="err">@classmethod</span>
  <span class="n">def</span> <span class="n">register_command_hook</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">)</span><span class="o">:</span>
    <span class="n">pass</span>
</code></pre>

<h3 id="skipping-hooks">Skipping Hooks</h3>

<p>To skip a hook, a user uses a command-line option, <code>--skip-hooks</code>. The option can either
specify specific hooks to skip, or &ldquo;all&rdquo;:</p>

<ul>
<li><code>aurora --skip-hooks=all job create east/bozo/devel/myjob</code> will create a job
without running any hooks.</li>
<li><code>aurora --skip-hooks=test,iq create east/bozo/devel/myjob</code> will create a job,
and will skip only the hooks named &ldquo;test&rdquo; and &ldquo;iq&rdquo;.</li>
</ul>

      </div>
    </div>
  	<div class="container-fluid section-footer buffer">
      <div class="container">
        <div class="row">
		  <div class="col-md-2 col-md-offset-1"><h3>Quick Links</h3>
		  <ul>
		    <li><a href="/downloads/">Downloads</a></li>
			<li><a href="https://github.com/aurora-scheduler/aurora/issues">Issue Tracking</a></li>
			<li><a href="/documentation/latest/contributing/">How To Contribute</a></li>     
		  </ul>
	      </div>
		  <div class="col-md-6">
			<p class="disclaimer">Licensed under the <a href="http://www.apache.org/licenses/">Apache License v2.0</a>. The <a href="https://www.flickr.com/photos/trondk/12706051375/">Aurora Borealis IX photo</a> displayed on the homepage is available under a <a href="https://creativecommons.org/licenses/by-nc-nd/2.0/">Creative Commons BY-NC-ND 2.0 license</a>.</p>
        </div>
      </div>
    </div>

  </body>
</html>
